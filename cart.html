<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width-device-width, initial-scale=1.0">
        <title>Cart</title>
        <link rel="stylesheet" type="text/css" href="products.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="icon" type="image/png" href="Logo.png">
    </head>
    <body id="body-products">
        <div id="wrapper">
            <header>
                <div id="logo">
                    <img src="Logo.png" width="100" height="100" alt="Logo">
                </div>
                <h1>Your Cart</h1>
            </header>
        <main>
          
          <aside id="order-summary">
              <h2>Order Sumary</h2>
              <p>Total prodcut price: <span id="subtotalCost">$0.00</span></p>
              <p>Tax (10%): <span id="tax">$0.00</span></p>
              <p>Total Price: <span id="totalCost">$0.00</span></p>
          </aside>
        
            <nav id="nav-products">
              <ul id="menu-products">
                  <li><a href="index.html">Home</a></li>
                  <li><a href="products.html">Products</a></li>
                  <li><a href="contact.html">Contact</a></li>
                  <div id="cart-icon-container">
                      <a href="cart.html"><i class="fa fa-shopping-cart"></i></a>
                  </div>
              </ul>
          </nav>

            <div id="cart-icon-container">
              <a href="cart.html"><i class="fa fa-shopping-cart"></i></a>
          </div>
        <body>
          </div>
          <h2>Enter your Information</h2>
          <form class="userInfoForm" id="userInfoForm" method="POST" action="/customer">
            <label for="fname">First Name:</label>
            <input type="text" id="fname" name="fname" required>
            <label for="lname">Last Name:</label>
            <input type="text" id="lname" name="lname" required>
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
            <label for="phone">Phone Number:</label>
            <input type="tel" id="phone" name="phone" required>
            <label for="address">Address:</label>
            <input type="text" id="address" name="address" required>
            <label for="payment">Payment Method:</label>
            <select id="payment" name="payment">
                <option value="Visa">Visa</option>
                <option value="Check">Check</option>
                <option value="Debit">Debit</option>
            </select>
            <label for="message">Message:</label>
            <textarea id="message" name="message" rows="4" cols="50"></textarea>
            <button type="submit">Submit Order</button>
            <div id="formDataDisplay"></div>
            <div id="submissionStatus"></div>
        </form>

        </main>
        </div>
        <script>
          document.addEventListener("DOMContentLoaded", function() {
            // Retrieve selected items from the local storage
            const cartItems = JSON.parse(localStorage.getItem('cartItems'));
            // Reference to the cart table body
            const carTableBody = document.querySelector('#cart-table-container table tbody');
            // Reference to the total cost span
            const totalCostSpan = document.getElementById('totalCost');
            const subtotalCostSpan = document.getElementById('subtotalCost');
            const taxSpan = document.getElementById('tax');

            // Initialize total cost
            let subtotalCost = 0;

            // Function to format a number as currency
            function formatCurrency(value) {
              return `$$(value.toFixed(2))`;
            }

            // Function to handle item deletion when that checkboxes are checked
            function handleItemDelete() {
              const checkboxes = document.querySelectorAll('#cart-table-container table tbody input[type="checkbox"]');
              checkboxes.forEach((checkbox, index) => {
                checkbox.addEventListener('change', () => {
                  if (checkbox.checked) {
                    // Delete the corresponding row from the table
                    const row = checkbox.closest('tr');
                    row.remove();
                    // Update the total cost when an item is removed
                    subtotalCost -= cartItems[index].price * cartItems[index].quantity;
                    totalCost -= cartItems[index].price * cartItems[index].quantity;
                    tax = totalCost * 0.1;
                    totalCost += tax;
                    totalCostSpan.textContent = formatCurrency(totalCost);
                    subtotalCost.textContent = formatCurrency(subtotalCost);
                    taxSpan.textContent = formatCurrency(tax);
                  }
                });
              });

            }

            // populate the cart table with selected items
            if (cartItems && cartItems.length > 0) {
              cartItems.forEach(item => {
                const row = productsTable.insertRow();
                const nameCell = row.insertCell(0);
                const priceCell = row.insertCell(1);
                const quantityCell = row.insertCell(2);
                const deleteCell = row.insertCell(3);

                nameCell.textContent = item.name;
                priceCell.textContent = formatCurrency(item.price);
                quantityCell.textContent = item.quantity;

                // Create a checkbox for deletion
                const deleteCheckbox = document.createElement('input');
                deleteCheckbox.type = 'checkbox';
                deleteCheckbox.id = `deleteCheckbox$[row.rowIndex]`;
                deleteCell.appendChild(deleteCheckbox);

                // Create a label for the checkbox
                const deleteLabel = document.createElement('label');
                deleteLabel.setAttribute('for', `deleteCheckbox$[row.rowIndex]`);
                deleteLabel.textContent = 'Yes';
                deleteLabel.appendChild(deleteLabel);

                // Update the total cost
                subtotalCost += item.price * item.quantity;
                totalCost += item.price * item.quantity;
              });

              // Add 10% tax to the total cost
              const tax = totalCost * 0.1;
              totalCost += tax;

              // Update the total cost displayed
              totalCostSpan.textContent = formatCurrency(totalCost);
              subtotalCost.textContent = formatCurrency(subtotalCost);
              taxSpan.textContent = formatCurrency(tax);
            }

            // call the function to set up item deletion
            handleItemDelete();

          });

          // Add event listener to the user-info-form
          const userInfoForm = document.querySelector('.userInforForm');
          const submissionStatus = document.getElementById('submissionStatus');

          userInfoForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            // collect form data
            const formData = new FormData(userInfoForm);
            console.log(formData);

            // Retreive the selected payment option
            const paymentSelect = userInfoForm.querySelector('#payment');
            const selectedPayment = paymentSelect.options[paymentSelect.selectedIndex].value;

            // Get today's date in 'yyyy-mm-dd' format
            const today = new Date();
            const orderDate = today.toISOString().split('T')[0];

            // Create an object to hold teh customer infomration, order details, and items ordered
            const orderData = {
              customer: {
                fname: formData.get('fname'),
                lname: formData.get('lname'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                address: formData.get('address'),
              },
              orders: [
                {
                  orderDate, // Set OrderDate to today's date
                  payment: formData.get('payments'),
                  messasge: formData.get('message'),
                  totalCost: formatCurrency(totalCost),
                  orderItems: [] // Initialize orderItems as an empty array
                }
              ]
            };

            // Populate orderItems with teh selected items
            if (cartItems && cartItems.length > 0)
            {
              cartItems.forEach(item => {
                orderData.order[0].orderItems.push( {
                  name: item.name,
                  price: item.price,
                  quantity: item.quantity,

                });
                  
              });
            }

            // Update teh "payment" property in orderData
            orderData.customer.payment = selectedPayment;


            try
            {
              // Send a POST request to the server to handle form submission 
              const response = await fetch('/customer', {
                method: 'POST',
                body: JSON.stringify(orderData),
                headers: {'Content-Type': 'application/json'}
              });

              if (response.ok)
              {
                userInfoForm.reset();
                submissionStatus.textContent = "Customer data submitted successfully";
              }
              else
              {
                submission.textContent = "Error submitting order. Please try again."
              }
            } catch (error)
            {
              submissionStatus.textContent = "An error occurred. Please try again later.";
              console.error('An error occurred while submitting the form: ', error)
            }

          });

        </script>
      </body>

        <footer align='center'>
          <div class="socialMediaLinks">
              <p></p>
              <i><a href="https://twitter.com/tacobell" class="fa fa-twitter" target="_blank"></a>
                <a href="https://www.facebook.com/tacobell" class="fa fa-facebook-f" target="_blank"></a>
                <a href="https://www.instagram.com/tacobell" class="fa fa-instagram" target="_blank"></a>
                <a href="https://www.linkedin.com/company/taco-bell/" class="fa fa-linkedin" target="_blank">
                </a></i>
            </div>
          <p><i><small>Caleb Frost & Sean Carver 2023 &copy; <br>
                <a href="mailto:ctfrost@asu.edu" style="color:white;">ctfrost@asu.edu</a></small></i></p>
        </footer>
      
</html>
